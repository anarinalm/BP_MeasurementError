# Data Examination

```{r message = FALSE}

library(dplyr)
library(tidyverse)
library(tibble)
library(ggplot2)
library(data.table)
library(DT)
library(broom)
library(devtools)
library(viridis)
library(knitr)
library(hrbrthemes)
#using data specified in this github repository:
install_github("jhs-hwg/cardioStatsUSA")
library(cardioStatsUSA)
```

```{r}
head(nhanes_data)
print(nrow(nhanes_data))
print(nrow(nhanes_data[svy_subpop_htn == 1]))
```

Following the example in <https://jhs-hwg.github.io/cardioStatsUSA/articles/replicate_nchs_2017.html>:

Can probably delete this block

```{r}
# Make a copy here so that we don't modify the NHANES data
# (doing so would break tests that are run after this one)
nhanes_data_test <- copy(nhanes_data)
# match the age groups of CDC report
nhanes_data_test[
 , demo_age_cat := cut(demo_age_years,
                       breaks = c(18, 39, 59, Inf),
                       labels = c("18-39", "40-59", "60+"),
                       include.lowest = TRUE)
]

nhanes_data_test <- nhanes_data_test %>%
 # exclude pregnant women
 .[demo_pregnant == 'No' | is.na(demo_pregnant)] %>%
 # exclude participants missing both SBP and DBP
 .[!(is.na(bp_dia_mean) & is.na(bp_sys_mean))]

print(paste0("n =", nrow(nhanes_data_test)))

ds <- nhanes_data_test %>%
 nhanes_design(
  key = nhanes_key,
  outcome_variable = 'htn_jnc7',
  group_variable = 'demo_age_cat',
  time_values = '2015-2016'
 )

print(ds)

ds_standard <- ds %>%
 nhanes_design_standardize(
  standard_variable = 'demo_age_cat',
  standard_weights = c(0.420263, 0.357202, 0.222535)
 )
```

Recreating the given graphs with the nhanes_visualize() function

```{r}
#nhanes_summarize(nhanes_data_test, nhanes_key, outcome_variable = "demo_age_cat")
nhanes_visualize(
  data = nhanes_data, 
  key = nhanes_key, 
  outcome_variable = "bp_sys_mean",
  outcome_stats = 'mean',
  standard_variable = "demo_age_cat", 
  time_values = c("2013-2014", "2015-2016", "2017-2020"), 
  group_variable = "demo_age_cat"
  )

nhanes_htn_subpop <- nhanes_data[nhanes_data$htn_accaha == "Yes", ]

nhanes_visualize(
  data = nhanes_htn_subpop, 
  key = nhanes_key, 
  outcome_variable = "bp_control_accaha",
  outcome_stats = 'percentage',
  standard_variable = "demo_age_cat", 
  group_variable = "demo_gender"
  )
```

```{r}
nhanes_visualize(
  data = nhanes_data, 
  key = nhanes_key, 
  outcome_variable = "bp_dia_mean",
  outcome_stats = 'mean',
  standard_variable = "demo_age_cat", 
  group_variable = "demo_gender"
  )
```

Demographic Histograms (Blood Pressure vs Demographic Variables)

Systolic vs Age and Systolic vs Gender are very clear

```{r}
nhanes_data %>% drop_na(bp_dia_mean) %>%
  ggplot(aes(x=bp_dia_mean, color=demo_age_cat)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Diastolic) with Age")

nhanes_data %>% drop_na(bp_sys_mean) %>%
  ggplot(aes(x=bp_sys_mean, color=demo_age_cat)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Systolic) with Age")

nhanes_data %>% drop_na(bp_sys_mean) %>%
  ggplot(aes(x=bp_sys_mean, color=demo_race)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Systolic) with Race")

nhanes_data %>% drop_na(bp_sys_mean) %>%
  ggplot(aes(x=bp_sys_mean, color=demo_gender)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Systolic) with Gender")

nhanes_female <- nhanes_data[nhanes_data$demo_gender == "Women", ]
nhanes_female %>% drop_na(demo_pregnant) %>% 
    ggplot(aes(x=bp_sys_mean, color=demo_pregnant)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Systolic) with Pregnancy (Men Excluded)")

nhanes_female %>% drop_na(demo_pregnant) %>% 
    ggplot(aes(x=bp_dia_mean, color=demo_pregnant)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure (Diastolic) with Pregnancy (Men Excluded)")
```

Comorbidities Box Plots (Blood Pressure vs Covariate)

```{r}
nhanes_data %>% drop_na(cc_smoke) %>%
  ggplot(aes(x=cc_smoke, y=bp_sys_mean, fill=cc_smoke)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Blood Pressure VS Smoking Status") +
    xlab("")

nhanes_data %>% drop_na(cc_bmi) %>%
  ggplot(aes(x=cc_bmi, y=bp_sys_mean, fill=cc_bmi)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Blood Pressure VS BMI Status") +
    xlab("")

nhanes_data %>% drop_na(cc_cvd_chd) %>%
  ggplot(aes(x=cc_cvd_chd, y=bp_sys_mean, fill=cc_cvd_chd)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Blood Pressure VS Chronic Heart Disease Status") +
    xlab("")

nhanes_data %>% drop_na(cc_ckd) %>%
  ggplot(aes(x=cc_ckd, y=bp_sys_mean, fill=cc_ckd)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Blood Pressure VS Chronic Kidney Disease Status") +
    xlab("")
```

Comorbidities Histograms (Blood Pressure vs Covariate)

```{r}
nhanes_data %>% drop_na(cc_smoke) %>%
  ggplot(aes(x=bp_sys_mean, color=cc_smoke)) +
    geom_histogram(fill="white", alpha=0.5, bins= 80) +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    ggtitle("Blood Pressure with Smoking Histogram")

nhanes_data %>% drop_na(cc_bmi) %>%
  ggplot(aes(x=bp_sys_mean, color=cc_bmi)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure with BMI Histogram")

nhanes_data %>% drop_na(cc_cvd_stroke) %>%
  ggplot(aes(x=bp_sys_mean, color=cc_cvd_stroke)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure with Stroke Histogram")

nhanes_data %>% drop_na(cc_diabetes) %>%
  ggplot(aes(x=bp_sys_mean, color=cc_diabetes)) +
    geom_histogram(fill="white", alpha=0.5, bins = 80) +
    ggtitle("Blood Pressure with Diabetes Histogram")
```

Chi Squared Tests (Testing difference between covariates and hypertension status)

I realize this isn't very useful (of course the result will be significant) but I left them in anyways

```{r}
#Body Mass Index
nhanes_bmi_df <- nhanes_data %>% select(htn_accaha, cc_bmi) %>% drop_na(cc_bmi)
nhanes_bmi_df <- table(nhanes_bmi_df$htn_accaha, nhanes_bmi_df$cc_bmi)
nhanes_bmi_df
chisq.test(nhanes_bmi_df)

#Smoking 
nhanes_smoke_df <- nhanes_data %>% select(htn_accaha, cc_smoke) %>% drop_na(cc_smoke)
nhanes_smoke_df <- table(nhanes_smoke_df$htn_accaha, nhanes_smoke_df$cc_smoke)
nhanes_smoke_df
chisq.test(nhanes_smoke_df)

#Chronic Heart Disease
nhanes_chd_df <- nhanes_data %>% select(htn_accaha, cc_cvd_chd) %>% drop_na(cc_cvd_chd)
nhanes_chd_df <- table(nhanes_chd_df$htn_accaha, nhanes_chd_df$cc_cvd_chd)
nhanes_chd_df
chisq.test(nhanes_chd_df)

#Chronic Kidney Disease
nhanes_ckd_df <- nhanes_data %>% select(htn_accaha, cc_ckd) %>% drop_na(cc_ckd)
nhanes_ckd_df <- table(nhanes_ckd_df$htn_accaha, nhanes_ckd_df$cc_ckd)
nhanes_ckd_df
chisq.test(nhanes_ckd_df)
```

Two Sample T Tests (Testing the Difference in blood pressure between comorbidities)

Should I extend to demographic data?

```{r}
#Don't know if this is the idea but:
nhanes_dia_df <- nhanes_data %>% select(htn_accaha, bp_dia_mean) %>% drop_na(bp_dia_mean)
nhanes_dia_df 
t_test <- t.test(bp_dia_mean ~ htn_accaha, data=nhanes_dia_df)
t_test

#Smoking T Test (Excludes Former):
nhanes_sys_smoke <- nhanes_data[nhanes_data$cc_smoke != "Former", ] %>% select(cc_smoke, bp_sys_mean) %>% drop_na(bp_sys_mean) %>% drop_na(cc_smoke)
smoke_test <- t.test(bp_sys_mean ~ cc_smoke, data = nhanes_sys_smoke)
smoke_test

#BMI T Test (Compares <25 and 35+):
nhanes_sys_bmi <- nhanes_data[nhanes_data$cc_bmi %in% c("<25", "35+"), ] %>% select(cc_bmi, bp_sys_mean) %>% drop_na(bp_sys_mean) %>% drop_na(cc_bmi)
bmi_test <- t.test(bp_sys_mean ~ cc_bmi, data = nhanes_sys_bmi)
bmi_test

#Diabetes T Test:
nhanes_sys_diabetes <- nhanes_data %>% select(cc_diabetes, bp_sys_mean) %>% drop_na(bp_sys_mean) %>% drop_na(cc_diabetes)
diabetes_test <- t.test(bp_sys_mean ~ cc_diabetes, data = nhanes_sys_diabetes)
diabetes_test
```

## Simple Diabetes Modeling

We are choosing Diabetes as the co-morbidity for modeling. We will try to predict the occurrence of diabetes as a function of blood pressure as well as other covariates.

The most basic model possible is a simple logistic regression model predicting diabetes status based on blood pressure:

```{r}
simple_diab_model_sys <- glm(cc_diabetes ~ bp_sys_mean, data = nhanes_data, family = binomial)

summary(simple_diab_model_sys)
knitr::kable(tidy(simple_diab_model_sys, exponentiate = TRUE, conf.int = TRUE))

simple_diab_model_dia <- glm(cc_diabetes ~ bp_dia_mean, data = nhanes_data, family = binomial)

summary(simple_diab_model_dia)
knitr::kable(tidy(simple_diab_model_dia, exponentiate = TRUE, conf.int = TRUE))
```

#### Model Explanation:

For the logistic regression using systolic blood pressure, we can see that the odds ratio beta parameter is 1.024. This implies that a higher systolic blood pressure corresponds to increased chances of observing diabetes.

A more exact interpretation would be that: for one additional unit increase in systolic blood pressure, the estimated odds of having diabetes increases by 2.4%.

This value may not seem extremely high, yet it still has a p value evaluated to be 0 by R. We can see that the confidence interval of this parameter ranges between 1.0229 and 1.0253, meaning that the model predicts this positive relationship with a high certainty, since the true value of the parameter is most likely within this interval. (Not sure what wording is best here)

The opposite is true with diastolic blood pressure: the beta parameter is 0.996, implying that higher diastolic blood pressure corresponds to a lower chance of observing diabetes. For an additional unit increase in diastolic blood pressure, the estimated odds of having diabetes decreases by 0.04%.

Note: systolic blood pressure is a better predictor of cardiovascular disease, so I chose to consider systolic rather than diastolic in future models.

## Demographic Model

Next, we build a model including the demographic variables as well. This will hopefully provide a more accurate model, since it will have access to the further information in order to make predictions.

```{r}
demo_diab_model_sys <- glm(cc_diabetes ~ bp_sys_mean + demo_age_years + demo_race + demo_gender,data = nhanes_data, family = binomial)

summary (demo_diab_model_sys)
knitr::kable(tidy(demo_diab_model_sys, exponentiate = TRUE, conf.int = TRUE))
```

#### Model Explanation

In this model, we can still see a slight upwards trend with systolic blood pressure, although it is a bit weaker (1.024 \> 1.003). With this parameter, the estimated odds of having diabetes increases only by 0.3%. Although the effect is smaller, we can see that the confidence interval is between 1.0024 and 1.0051, which does not include 1. So, although small, the positive relationship is most likely significant.

#### Demographics

**Age:**

The model also tells us that age is positively correlated with the observation of diabetes. With a log odds ratio of 1.054, it seems that every year increases the odds of diabetes occurrence by 5.4%.

**Race:**

With race, the "reference group" is Non-Hispanic White. The log odds ratio here compares the other variables to the baseline reference group. We can see that, in comparison to this group, all other races have significantly higher odds of diabetes. For example, the Hispanic population's odds of diabetes occurrence is 2.36 times higher than the Non-Hispanic White population.

**Gender:**

With this variable, the reference group is men. We can see that women have a lower odds of having diabetes compared to men. Specifically, the odds of diabetes in women is about 85.6% of the odds in men.

## Full Model

Lastly, we want to create a model including confounding variables. To achieve this, we must first determine which other variables are confounding, meaning they have significant associations with diabetes.

We can achieve this by using chi squared test, which compares whether or not the observed ratios of diabetes and confounding variables matches the ratios expected by random chance. If the chi squared test determines significance, then diabetes and the other variables commonly occur together and therefore are confounding.

#### Perform Chi Squared Tests:

```{r}
#Testing for BMI
nhanes_bmi_diab <- nhanes_data %>% select(cc_diabetes, cc_bmi) %>% drop_na(cc_bmi) %>% drop_na(cc_diabetes)
nhanes_bmi_diab <- table(nhanes_bmi_diab)
nhanes_bmi_diab
chisq.test(nhanes_bmi_df)

#Testing for Smoking
nhanes_smoke_diab <- nhanes_data %>% select(cc_diabetes, cc_smoke) %>% drop_na(cc_smoke) %>% drop_na(cc_diabetes)
nhanes_smoke_diab <- table(nhanes_smoke_diab)
nhanes_smoke_diab
chisq.test(nhanes_smoke_diab)

#Testing for Hypertensive Medication use
nhanes_med_diab <- nhanes_data %>% select(cc_diabetes, bp_med_use) %>% drop_na(bp_med_use) %>% drop_na(cc_diabetes)
nhanes_med_diab <- table(nhanes_med_diab)
nhanes_med_diab
chisq.test(nhanes_med_diab)
```

After this analysis, we can see that all three variables, BMI, Smoking, and Medication Use, are all confounding. We can include all of them in the next model, in addition to systolic blood pressure and the demographic variables:

```{r}
full_diab_model_sys <- glm(cc_diabetes ~ bp_sys_mean + demo_age_years + demo_race + demo_gender+ cc_bmi + cc_smoke + bp_med_use, data = nhanes_data, family = binomial)

summary(full_diab_model_sys)
knitr::kable(tidy(full_diab_model_sys, exponentiate = TRUE, conf.int = TRUE))
```

#### Model Explanation

The previous variables in this model continue to show the same patterns, although again, the effect of systolic blood pressure is again reduced due to a lower log odds ratio. Now, the p value seems to be much higher at 0.02 (which is still significant, but much less so). The demographic variables also have much the same pattern, although Non-Hispanic Asians seem to have a much higher odds ratio than in the previous model.

#### Covariates

**BMI**:

In this variable, the baseline reference level is bmi \<25. In comparison, those with higher bmi have increased odds of having diabetes, with the odds increasing the higher the bmi becomes. For example, those with bmi from 25-30 have a 1.8 times higher likelihood, while those with a bmi of 35+ have a 5.8 times higher likelihood.

**Smoking:**

With a baseline level of nonsmoking, former smokers may have about a 6% higher likelihood of diabetes. This may not be significant, however, given that the p value is only 0.067 and the odds ratio of 1 falls within the confidence interval. Current smokers, on the other hand, have about a 20% higher likelihood, this time with a much lower p value of 4\*10\^-6

**Blood Pressure Medication Use**:

Compared to those who do not use blood pressure medication, individuals who do have about a 2.5 times higher likelihood of experiencing diabetes.

## Model Selection

It is possible to find an even better model by modifying which variables we include in our logistic regression model. We can achieve this using model selection, which will selectively add or subtract our explanatory variables from the model and evaluate its performance to choose the final best set of variables.

Explanation of model selection and or AIC?
